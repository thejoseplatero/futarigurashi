<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Writer — FUTARIGURASHI</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&family=Libre+Baskerville:ital@0;1&display=swap" rel="stylesheet">
  <style>
    .writer-wrap { max-width: 42rem; margin: 0 auto; padding: var(--space-m); }
    .writer-wrap h1 { font-size: 1.25rem; margin-bottom: var(--space-m); }
    .writer-form label { display: block; font-weight: 500; margin-bottom: 0.25rem; font-size: 0.9rem; }
    .writer-form input[type="text"],
    .writer-form input[type="date"],
    .writer-form textarea { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--color-border); border-radius: var(--radius); font-family: inherit; font-size: 1rem; margin-bottom: var(--space-s); }
    .writer-form textarea { min-height: 120px; resize: vertical; }
    .writer-form .body-field { min-height: 280px; }
    .writer-form .hint { font-size: 0.8rem; color: var(--color-text-muted); margin-top: -0.5rem; margin-bottom: var(--space-s); }
    .writer-actions { display: flex; gap: var(--space-s); margin-top: var(--space-m); flex-wrap: wrap; }
    .writer-actions button { padding: 0.5rem 1rem; border-radius: var(--radius); font-family: inherit; font-size: 0.95rem; cursor: pointer; border: none; }
    .btn-primary { background: var(--color-accent); color: #fff; }
    .btn-primary:hover { background: var(--color-accent-hover); }
    .btn-secondary { background: var(--color-border); color: var(--color-text); }
    .btn-secondary:hover { background: #ddd; }
    .btn-danger { background: #b00; color: #fff; }
    .btn-danger:hover { background: #900; }
    .writer-back { margin-bottom: var(--space-m); font-size: 0.9rem; }
    .save-status { margin-top: var(--space-s); font-size: 0.9rem; }
    .save-status.ok { color: #0a6b0a; }
    .save-status.err { color: #b00; }
    .post-list { width: 100%; border-collapse: collapse; }
    .post-list th, .post-list td { padding: 0.5rem 0.75rem; text-align: left; border-bottom: 1px solid var(--color-border); }
    .post-list th { font-weight: 600; }
    .post-list .status-draft { color: var(--color-text-muted); font-size: 0.85rem; }
    .post-list .status-published { color: #0a6b0a; font-size: 0.85rem; }
    .post-list .actions { white-space: nowrap; }
    .post-list .actions a, .post-list .actions button { margin-right: 0.5rem; font-size: 0.9rem; }
    .post-list .post-list-categories { font-size: 0.85rem; color: var(--color-text-muted); max-width: 12rem; }
    .writer-nav { display: flex; gap: var(--space-m); margin-bottom: var(--space-m); flex-wrap: wrap; align-items: center; }
    .writer-nav a { font-size: 0.9rem; }
    .writer-lang { margin-left: auto; font-size: 0.85rem; }
    .writer-lang button { background: none; border: none; cursor: pointer; padding: 0.25rem 0.5rem; color: var(--color-text-muted); font-family: inherit; }
    .writer-lang button:hover { color: var(--color-text); }
    .writer-lang button.active { font-weight: 600; color: var(--color-text); }
    #listView.hidden, #editView.hidden { display: none !important; }
    .list-loading { padding: var(--space-m); color: var(--color-text-muted); }
    .delete-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 100; }
    .delete-overlay.hidden { display: none !important; }
    .delete-modal { background: var(--color-bg, #fff); padding: var(--space-m); border-radius: var(--radius); max-width: 24rem; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
    .delete-modal h3 { margin: 0 0 var(--space-s); font-size: 1.1rem; }
    .delete-modal p { margin: 0 0 var(--space-m); font-size: 0.95rem; color: var(--color-text-muted, #555); }
    .delete-modal label { display: block; font-size: 0.9rem; margin-bottom: 0.25rem; }
    .delete-modal input { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--color-border); border-radius: var(--radius); margin-bottom: var(--space-m); }
    .delete-modal .modal-actions { display: flex; gap: var(--space-s); justify-content: flex-end; }
    .delete-modal .modal-actions button:disabled { opacity: 0.6; cursor: not-allowed; }
    .body-toolbar { display: flex; flex-wrap: wrap; gap: var(--space-s); align-items: center; margin-bottom: var(--space-s); }
    .body-toolbar button { padding: 0.35rem 0.75rem; font-size: 0.9rem; border-radius: var(--radius); border: 1px solid var(--color-border); background: var(--color-bg); cursor: pointer; font-family: inherit; }
    .body-toolbar button:hover { background: #f0f0f0; }
    .body-images { margin-top: var(--space-s); }
    .body-images h4 { font-size: 0.9rem; margin: 0 0 0.5rem; font-weight: 600; }
    .body-images-list { display: flex; flex-wrap: wrap; gap: var(--space-s); align-items: flex-start; }
    .body-images-item { position: relative; border: 1px solid var(--color-border); border-radius: var(--radius); overflow: hidden; max-width: 160px; }
    .body-images-item img { display: block; max-width: 100%; height: auto; max-height: 120px; object-fit: cover; }
    .body-images-item .img-remove { position: absolute; top: 2px; right: 2px; padding: 0.2rem 0.4rem; font-size: 0.75rem; background: rgba(0,0,0,0.7); color: #fff; border: none; border-radius: 3px; cursor: pointer; }
    .body-images-item .img-remove:hover { background: #b00; }
    .body-preview { margin-top: var(--space-m); padding: var(--space-s); border: 1px solid var(--color-border); border-radius: var(--radius); background: #fafafa; max-height: 320px; overflow: auto; }
    .body-preview h4 { font-size: 0.9rem; margin: 0 0 0.5rem; font-weight: 600; }
    .body-preview .preview-content { font-size: 0.9rem; line-height: 1.5; }
    .body-preview .preview-content img { max-width: 100%; height: auto; vertical-align: middle; margin: 0.25rem 0; }
  </style>
</head>
<body>
  <div id="deleteOverlay" class="delete-overlay hidden">
    <div class="delete-modal">
      <h3 id="deleteModalTitle" data-i18n="deleteModalTitle">記事を削除</h3>
      <p id="deleteConfirmMessage"><span id="deleteConfirmPrefix"></span><span id="deleteConfirmTitle"></span><span id="deleteConfirmSuffix"></span></p>
      <label for="deleteConfirmInput" id="deleteConfirmLabel" data-i18n="deleteConfirmLabel">削除するには「削除」と入力してください</label>
      <input type="text" id="deleteConfirmInput" data-i18n-ph="deletePlaceholder" autocomplete="off">
      <div class="modal-actions">
        <button type="button" class="btn-secondary" id="deleteCancelBtn" data-i18n="deleteCancel">キャンセル</button>
        <button type="button" class="btn-danger" id="deleteConfirmBtn" data-i18n="deleteConfirm" disabled>削除する</button>
      </div>
    </div>
  </div>
  <div class="site-wrap">
    <div class="writer-nav">
      <a href="#" id="backToList" class="writer-back" data-i18n="navBackToList">← 記事一覧</a>
      <a href="#" id="backToBlog" class="writer-back" data-i18n="navViewBlog">ブログを見る</a>
      <span class="writer-api-hint" id="apiHint" style="display: none; font-size: 0.8rem; color: var(--color-text-muted);"></span>
      <span class="writer-lang">
        <button type="button" id="langJa" aria-pressed="true">日本語</button>
        <span aria-hidden="true"> / </span>
        <button type="button" id="langEn" aria-pressed="false">English</button>
      </span>
    </div>

    <div id="listView" class="writer-wrap">
      <h1 id="listTitle" data-i18n="listTitle">記事一覧</h1>
      <p><button type="button" class="btn-primary" id="btnNewPost" data-i18n="btnNewPost">新規記事</button></p>
      <div id="listContent" class="list-loading" data-i18n="loading">読み込み中…</div>
    </div>

    <div id="editView" class="writer-wrap hidden">
      <h1 id="editTitle">New post</h1>
      <form class="writer-form" id="postForm">
        <input type="hidden" id="slug" name="slug">
        <label for="title" data-i18n="labelTitle">タイトル</label>
        <input type="text" id="title" name="title" required data-i18n-ph="placeholderTitle">

        <label for="date" data-i18n="labelDate">日付</label>
        <input type="date" id="date" name="date" required>
        <p class="hint" data-i18n="hintDate">公開日（YYYY-MM-DD）</p>

        <label for="categories" data-i18n="labelCategories">カテゴリー（カンマ区切り）</label>
        <input type="text" id="categories" name="categories" data-i18n-ph="placeholderCategories">
        <p class="hint" data-i18n="hintCategories">例: 旅行, ブラジル</p>

        <label for="excerpt" data-i18n="labelExcerpt">抜粋（一覧用・任意）</label>
        <textarea id="excerpt" name="excerpt" rows="2" data-i18n-ph="placeholderExcerpt"></textarea>

        <label for="body" data-i18n="labelBody">本文（Markdown可）</label>
        <div class="body-toolbar">
          <button type="button" id="btnInsertImage" data-i18n="btnInsertImage">画像を挿入</button>
        </div>
        <textarea id="body" name="body" class="body-field" required data-i18n-ph="placeholderBody"></textarea>
        <div class="body-images" id="bodyImagesSection" style="display: none;">
          <h4 id="bodyImagesTitle" data-i18n="bodyImagesTitle">本文の画像</h4>
          <div class="body-images-list" id="bodyImagesList"></div>
        </div>
        <div class="body-preview" id="bodyPreviewSection">
          <h4 id="bodyPreviewTitle" data-i18n="bodyPreviewTitle">プレビュー</h4>
          <div class="body-preview-content preview-content" id="bodyPreviewContent"></div>
        </div>
        <p class="hint" data-i18n="hintMarkdown">Markdown: **太字** / ## 見出し / ![alt](images/ファイル.jpg)</p>

        <div class="writer-actions">
          <button type="button" class="btn-secondary" id="btnSaveDraft" data-i18n="btnSaveDraft">下書き保存</button>
          <button type="button" class="btn-primary" id="btnPublish" data-i18n="btnPublish">公開する</button>
        </div>
      </form>
      <div class="save-status" id="saveStatus"></div>
    </div>
  </div>

  <script>
    (function () {
      // When not served by writer-server (port 3765), call API at localhost:3765 (CORS allowed)
      var API_BASE = (location.hostname === 'localhost' && location.port === '3765') ? '' : 'http://localhost:3765';

      var STRINGS = {
        ja: {
          navBackToList: '← 記事一覧',
          navViewBlog: 'ブログを見る',
          listTitle: '記事一覧',
          btnNewPost: '新規記事',
          loading: '読み込み中…',
          editTitleNew: '新規記事',
          editTitleEdit: '記事を編集',
          labelTitle: 'タイトル',
          placeholderTitle: '記事のタイトル',
          labelDate: '日付',
          hintDate: '公開日（YYYY-MM-DD）',
          labelCategories: 'カテゴリー（カンマ区切り）',
          placeholderCategories: '旅行, ブラジル',
          hintCategories: '例: 旅行, ブラジル',
          labelExcerpt: '抜粋（一覧用・任意）',
          placeholderExcerpt: '最初の1〜2文を書くと一覧で表示されます',
          labelBody: '本文（Markdown可）',
          placeholderBody: '本文をここに。\n\n画像: ![説明](images/photo.jpg)\n見出し: ## 見出し',
          hintMarkdown: 'Markdown: **太字** / ## 見出し / ![alt](images/ファイル.jpg)',
          btnSaveDraft: '下書き保存',
          btnPublish: '公開する',
          btnInsertImage: '画像を挿入',
          bodyImagesTitle: '本文の画像',
          bodyPreviewTitle: 'プレビュー',
          imgRemove: '削除',
          deleteModalTitle: '記事を削除',
          deleteConfirmPrefix: '「',
          deleteConfirmSuffix: '」を削除しますか？',
          deleteConfirmLabel: '削除するには「削除」と入力してください',
          deletePlaceholder: '削除',
          deleteCancel: 'キャンセル',
          deleteConfirm: '削除する',
          tableTitle: 'タイトル',
          tableCategories: 'カテゴリー',
          tableDate: '日付',
          tableStatus: '状態',
          statusDraft: '下書き',
          statusPublished: '公開',
          editLink: '編集',
          deleteLink: '削除',
          noPosts: '記事がありません。「新規記事」から追加してください。',
          listError: '一覧の取得に失敗しました。writer-server が起動しているか確認してください。',
          apiHint: 'writer-server を port 3765 で起動してください: node writer-server.js',
          loadPostError: '記事の読み込みに失敗しました',
          saving: '保存中…',
          draftSaved: '下書きを保存しました',
          saveFailed: '保存に失敗しました',
          publishing: '公開中…（ビルドと push に少し時間がかかります）',
          published: '公開しました。ブログで確認できます。',
          publishFailed: '公開に失敗しました',
          deleteFailed: '削除に失敗しました'
        },
        en: {
          navBackToList: '← Post list',
          navViewBlog: 'View blog',
          listTitle: 'Post list',
          btnNewPost: 'New post',
          loading: 'Loading…',
          editTitleNew: 'New post',
          editTitleEdit: 'Edit post',
          labelTitle: 'Title',
          placeholderTitle: 'Post title',
          labelDate: 'Date',
          hintDate: 'Publish date (YYYY-MM-DD)',
          labelCategories: 'Categories (comma-separated)',
          placeholderCategories: 'Travel, Brazil',
          hintCategories: 'e.g. Travel, Brazil',
          labelExcerpt: 'Excerpt (optional, for list)',
          placeholderExcerpt: 'First 1–2 sentences will show in the list',
          labelBody: 'Body (Markdown OK)',
          placeholderBody: 'Write your post here.\n\nImage: ![alt](images/photo.jpg)\nHeading: ## Heading',
          hintMarkdown: 'Markdown: **bold** / ## heading / ![alt](images/file.jpg)',
          btnSaveDraft: 'Save draft',
          btnPublish: 'Publish',
          btnInsertImage: 'Insert image',
          bodyImagesTitle: 'Images in body',
          bodyPreviewTitle: 'Preview',
          imgRemove: 'Remove',
          deleteModalTitle: 'Delete post',
          deleteConfirmPrefix: 'Delete "',
          deleteConfirmSuffix: '"? Are you sure?',
          deleteConfirmLabel: 'Type "delete" to confirm',
          deletePlaceholder: 'delete',
          deleteCancel: 'Cancel',
          deleteConfirm: 'Delete',
          tableTitle: 'Title',
          tableCategories: 'Categories',
          tableDate: 'Date',
          tableStatus: 'Status',
          statusDraft: 'Draft',
          statusPublished: 'Published',
          editLink: 'Edit',
          deleteLink: 'Delete',
          noPosts: 'No posts yet. Add one with "New post".',
          listError: 'Failed to load list. Is writer-server running?',
          apiHint: 'Start writer-server on port 3765: node writer-server.js',
          loadPostError: 'Failed to load post',
          saving: 'Saving…',
          draftSaved: 'Draft saved',
          saveFailed: 'Save failed',
          publishing: 'Publishing… (build and push may take a moment)',
          published: 'Published. You can check the blog.',
          publishFailed: 'Publish failed',
          deleteFailed: 'Delete failed'
        }
      };

      var lang = (typeof localStorage !== 'undefined' && localStorage.getItem('writerLang')) || 'ja';
      if (lang !== 'ja' && lang !== 'en') lang = 'ja';

      function t(key) { return (STRINGS[lang] && STRINGS[lang][key]) || STRINGS.ja[key] || key; }

      function applyLang() {
        document.documentElement.lang = lang;
        document.querySelectorAll('[data-i18n]').forEach(function (el) {
          var key = el.getAttribute('data-i18n');
          if (key && el.id !== 'deleteConfirmTitle') el.textContent = t(key);
        });
        document.querySelectorAll('[data-i18n-ph]').forEach(function (el) {
          var key = el.getAttribute('data-i18n-ph');
          if (key) el.placeholder = t(key);
        });
        document.getElementById('deleteConfirmPrefix').textContent = t('deleteConfirmPrefix');
        document.getElementById('deleteConfirmSuffix').textContent = t('deleteConfirmSuffix');
        document.getElementById('langJa').classList.toggle('active', lang === 'ja');
        document.getElementById('langJa').setAttribute('aria-pressed', lang === 'ja');
        document.getElementById('langEn').classList.toggle('active', lang === 'en');
        document.getElementById('langEn').setAttribute('aria-pressed', lang === 'en');
        var hintEl = document.getElementById('apiHint');
        if (API_BASE) {
          hintEl.style.display = 'inline';
          hintEl.textContent = t('apiHint');
        } else {
          hintEl.style.display = 'none';
        }
        if (!listView.classList.contains('hidden')) loadList();
        if (editView.classList.contains('hidden') === false) {
          editTitleEl.textContent = slugInput.value ? t('editTitleEdit') : t('editTitleNew');
        }
      }

      function setLang(newLang) {
        lang = newLang;
        try { localStorage.setItem('writerLang', lang); } catch (e) {}
        applyLang();
      }

      var listView = document.getElementById('listView');
      var editView = document.getElementById('editView');
      var listContent = document.getElementById('listContent');
      var backToList = document.getElementById('backToList');
      var backToBlog = document.getElementById('backToBlog');
      var btnNewPost = document.getElementById('btnNewPost');
      var form = document.getElementById('postForm');
      var slugInput = document.getElementById('slug');
      var titleInput = document.getElementById('title');
      var dateInput = document.getElementById('date');
      var categoriesInput = document.getElementById('categories');
      var excerptInput = document.getElementById('excerpt');
      var bodyInput = document.getElementById('body');
      var saveStatus = document.getElementById('saveStatus');
      var editTitleEl = document.getElementById('editTitle');

      document.getElementById('langJa').addEventListener('click', function () { setLang('ja'); });
      document.getElementById('langEn').addEventListener('click', function () { setLang('en'); });
      applyLang();

      function getBodyImages(text) {
        var out = [];
        var m;
        var reMd = /!\[([^\]]*)\]\(([^)]+)\)/g;
        while ((m = reMd.exec(text)) !== null) {
          out.push({ alt: m[1], url: m[2], raw: m[0] });
        }
        var reImg = /<img[^>]+src=["']([^"']+)["'][^>]*>/gi;
        while ((m = reImg.exec(text)) !== null) {
          var altMatch = m[0].match(/alt=["']([^"']*)["']/i);
          out.push({ alt: altMatch ? altMatch[1] : '', url: m[1], raw: m[0] });
        }
        return out;
      }

      function updateBodyImagesAndPreview() {
        var text = bodyInput.value;
        var images = getBodyImages(text);
        var listEl = document.getElementById('bodyImagesList');
        var sectionEl = document.getElementById('bodyImagesSection');
        listEl.innerHTML = '';
        if (images.length) {
          sectionEl.style.display = 'block';
          images.forEach(function (img) {
            var wrap = document.createElement('div');
            wrap.className = 'body-images-item';
            var im = document.createElement('img');
            im.src = img.url;
            im.alt = img.alt;
            im.referrerPolicy = 'no-referrer';
            im.onerror = function () { this.style.background = '#eee'; this.alt = img.url; };
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'img-remove';
            btn.textContent = t('imgRemove');
            btn.setAttribute('data-raw', img.raw);
            btn.addEventListener('click', function () {
              var raw = btn.getAttribute('data-raw');
              bodyInput.value = bodyInput.value.replace(raw, '');
              updateBodyImagesAndPreview();
            });
            wrap.appendChild(im);
            wrap.appendChild(btn);
            listEl.appendChild(wrap);
          });
        } else {
          sectionEl.style.display = 'none';
        }
        var previewEl = document.getElementById('bodyPreviewContent');
        var previewHtml = text
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" referrerpolicy="no-referrer">');
        previewEl.innerHTML = previewHtml.split(/\n/).join('<br>');
      }

      bodyInput.addEventListener('input', updateBodyImagesAndPreview);
      bodyInput.addEventListener('change', updateBodyImagesAndPreview);

      document.getElementById('btnInsertImage').addEventListener('click', function () {
        var url = prompt(lang === 'ja' ? '画像のURLを入力' : 'Enter image URL');
        if (url == null || !url.trim()) return;
        url = url.trim();
        var alt = prompt(lang === 'ja' ? '代替テキスト（任意）' : 'Alt text (optional)');
        if (alt == null) return;
        var insert = '![' + (alt || '') + '](' + url + ')';
        var ta = bodyInput;
        var start = ta.selectionStart;
        var end = ta.selectionEnd;
        var before = ta.value.slice(0, start);
        var after = ta.value.slice(end);
        ta.value = before + insert + after;
        ta.selectionStart = ta.selectionEnd = start + insert.length;
        ta.focus();
        updateBodyImagesAndPreview();
      });

      function slugFromTitle(s) {
        return String(s || '')
          .trim()
          .replace(/\s+/g, '-')
          .replace(/[^\w\u3040-\u309f\u30a0-\u30ff\u4e00-\u9faf-]/g, '')
          .replace(/-+/g, '-')
          .slice(0, 80) || 'post';
      }

      function showList() {
        location.hash = '';
        listView.classList.remove('hidden');
        editView.classList.add('hidden');
        loadList();
      }

      function showEdit(slug) {
        location.hash = slug ? 'edit/' + slug : 'new';
        listView.classList.add('hidden');
        editView.classList.remove('hidden');
        if (slug) {
          editTitleEl.textContent = t('editTitleEdit');
          loadPost(slug);
        } else {
          editTitleEl.textContent = t('editTitleNew');
          slugInput.value = '';
          titleInput.value = '';
          dateInput.value = new Date().toISOString().slice(0, 10);
          categoriesInput.value = '';
          excerptInput.value = '';
          bodyInput.value = '';
          updateBodyImagesAndPreview();
          saveStatus.textContent = '';
          saveStatus.className = 'save-status';
        }
      }

      function loadList() {
        listContent.innerHTML = t('loading');
        fetch(API_BASE + '/api/posts')
          .then(function (r) {
            if (!r.ok) throw new Error('API ' + r.status);
            return r.json();
          })
          .then(function (posts) {
            if (!Array.isArray(posts)) throw new Error('Invalid response');
            if (!posts.length) {
              listContent.innerHTML = '<p>' + t('noPosts') + '</p>';
              return;
            }
            var html = '<table class="post-list"><thead><tr><th>' + t('tableTitle') + '</th><th>' + t('tableCategories') + '</th><th>' + t('tableDate') + '</th><th>' + t('tableStatus') + '</th><th></th></tr></thead><tbody>';
            posts.forEach(function (p) {
              var cats = Array.isArray(p.categories) ? p.categories : (p.categories ? [p.categories] : []);
              var categoriesText = cats.map(function (c) { return escapeHtml(String(c)); }).join(', ');
              var statusClass = p.status === 'draft' ? 'status-draft' : 'status-published';
              var statusText = p.status === 'draft' ? t('statusDraft') : t('statusPublished');
              html += '<tr><td>' + escapeHtml(p.title) + '</td><td class="post-list-categories">' + categoriesText + '</td><td>' + escapeHtml(p.date) + '</td><td class="' + statusClass + '">' + statusText + '</td><td class="actions">';
              html += '<a href="#edit/' + escapeHtml(p.slug) + '">' + t('editLink') + '</a>';
              html += '<button type="button" class="btn-danger" data-slug="' + escapeHtml(p.slug) + '" data-title="' + escapeHtml(p.title) + '">' + t('deleteLink') + '</button>';
              html += '</td></tr>';
            });
            html += '</tbody></table>';
            listContent.innerHTML = html;
            listContent.querySelectorAll('button[data-slug]').forEach(function (btn) {
              btn.addEventListener('click', function () {
                showDeleteConfirm(btn.getAttribute('data-slug'), btn.getAttribute('data-title'));
              });
            });
            listContent.querySelectorAll('a[href^="#edit/"]').forEach(function (a) {
              a.addEventListener('click', function (e) {
                e.preventDefault();
                var slug = (a.getAttribute('href') || '').replace(/^#edit\//, '');
                try { slug = decodeURIComponent(slug); } catch (x) {}
                showEdit(slug);
              });
            });
          })
          .catch(function (err) {
            var msg = t('listError');
            if (API_BASE && (err.message === 'Failed to fetch' || err.name === 'TypeError')) {
              msg = (lang === 'ja' ? 'writer-server に接続できません。ターミナルで「node writer-server.js」を実行してから再読み込みしてください。（port 3765）' : 'Cannot reach writer-server. Run "node writer-server.js" in the futarigurashi folder, then reload. (port 3765)');
            } else if (err.message && err.message.indexOf('API') === 0) {
              msg = (lang === 'ja' ? 'API エラー: ' : 'API error: ') + err.message;
            }
            listContent.innerHTML = '<p class="save-status err">' + msg + '</p>';
          });
      }

      function loadPost(slug) {
        saveStatus.textContent = t('loading');
        saveStatus.className = 'save-status';
        fetch(API_BASE + '/api/posts/' + encodeURIComponent(slug))
          .then(function (r) {
            if (!r.ok) throw new Error('Not found');
            return r.json();
          })
          .then(function (p) {
            slugInput.value = p.slug || '';
            titleInput.value = p.title || '';
            dateInput.value = (p.date || '').slice(0, 10) || new Date().toISOString().slice(0, 10);
            categoriesInput.value = Array.isArray(p.categories) ? p.categories.join(', ') : (p.categories || '');
            excerptInput.value = p.excerpt || '';
            bodyInput.value = p.body || '';
            updateBodyImagesAndPreview();
            saveStatus.textContent = '';
          })
          .catch(function () {
            saveStatus.textContent = t('loadPostError');
            saveStatus.className = 'save-status err';
          });
      }

      function getFormData() {
        var catStr = categoriesInput.value.trim();
        return {
          slug: slugInput.value.trim() || slugFromTitle(titleInput.value),
          title: titleInput.value.trim(),
          date: dateInput.value.trim(),
          categories: catStr ? catStr.split(',').map(function (c) { return c.trim(); }).filter(Boolean) : [],
          excerpt: excerptInput.value.trim(),
          body: bodyInput.value.trim()
        };
      }

      function setStatus(msg, isErr) {
        saveStatus.textContent = msg;
        saveStatus.className = 'save-status' + (isErr ? ' err' : ' ok');
      }

      document.getElementById('btnSaveDraft').addEventListener('click', function () {
        var data = getFormData();
        saveStatus.textContent = t('saving');
        saveStatus.className = 'save-status';
        fetch(API_BASE + '/api/posts/draft', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        })
          .then(function (r) { return r.json(); })
          .then(function (res) {
            if (res.error) {
              setStatus(res.error, true);
              return;
            }
            slugInput.value = res.slug || data.slug;
            setStatus(t('draftSaved'));
          })
          .catch(function () {
            setStatus(t('saveFailed'), true);
          });
      });

      document.getElementById('btnPublish').addEventListener('click', function () {
        var data = getFormData();
        saveStatus.textContent = t('publishing');
        saveStatus.className = 'save-status';
        fetch(API_BASE + '/api/posts/publish', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        })
          .then(function (r) { return r.json(); })
          .then(function (res) {
            if (res.error) {
              setStatus(res.error + (res.detail ? ': ' + res.detail : ''), true);
              return;
            }
            slugInput.value = res.slug || data.slug;
            setStatus(t('published'));
          })
          .catch(function () {
            setStatus(t('publishFailed'), true);
          });
      });

      backToList.addEventListener('click', function (e) {
        e.preventDefault();
        showList();
      });
      backToBlog.addEventListener('click', function (e) {
        e.preventDefault();
        window.open(backToBlog.href, '_blank');
      });
      fetch(API_BASE + '/api/config').then(function (r) { return r.json(); }).then(function (c) {
        if (c.siteUrl) backToBlog.href = c.siteUrl;
      }).catch(function () {});

      btnNewPost.addEventListener('click', function () {
        showEdit(null);
      });

      function escapeHtml(s) {
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      var deleteConfirmSlug = null;

      function showDeleteConfirm(slug, title) {
        deleteConfirmSlug = slug;
        document.getElementById('deleteConfirmTitle').textContent = title || slug;
        document.getElementById('deleteConfirmInput').value = '';
        document.getElementById('deleteConfirmInput').placeholder = t('deletePlaceholder');
        document.getElementById('deleteConfirmBtn').disabled = true;
        document.getElementById('deleteOverlay').classList.remove('hidden');
        document.getElementById('deleteConfirmInput').focus();
      }

      function hideDeleteConfirm() {
        document.getElementById('deleteOverlay').classList.add('hidden');
        deleteConfirmSlug = null;
      }

      document.getElementById('deleteConfirmInput').addEventListener('input', function () {
        document.getElementById('deleteConfirmBtn').disabled = this.value.trim() !== t('deletePlaceholder');
      });

      document.getElementById('deleteConfirmBtn').addEventListener('click', function () {
        if (this.disabled || !deleteConfirmSlug) return;
        var slug = deleteConfirmSlug;
        hideDeleteConfirm();
        fetch(API_BASE + '/api/posts/' + encodeURIComponent(slug), { method: 'DELETE' })
          .then(function (r) { return r.json(); })
          .then(function () { loadList(); })
          .catch(function () { alert(t('deleteFailed')); });
      });

      document.getElementById('deleteCancelBtn').addEventListener('click', hideDeleteConfirm);
      document.getElementById('deleteOverlay').addEventListener('click', function (e) {
        if (e.target === this) hideDeleteConfirm();
      });

      function onHashChange() {
        var hash = (location.hash || '').replace(/^#/, '');
        if (hash === 'new') {
          showEdit(null);
          return;
        }
        if (hash.indexOf('edit/') === 0) {
          var slug = hash.slice(5);
          try { slug = decodeURIComponent(slug); } catch (x) {}
          showEdit(slug);
          return;
        }
        listView.classList.remove('hidden');
        editView.classList.add('hidden');
        loadList();
      }
      window.addEventListener('hashchange', onHashChange);
      if (location.hash) onHashChange(); else loadList();
    })();
  </script>
</body>
</html>
